<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persistence Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .pass {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button {
            margin: 5px;
            padding: 10px 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>MAGI Calculator - Persistence Test</h1>
    <p>This page tests the localStorage persistence functionality</p>

    <div id="results"></div>

    <h2>Manual Tests</h2>
    <button onclick="testSave()">Test Save</button>
    <button onclick="testLoad()">Test Load</button>
    <button onclick="testClear()">Test Clear</button>
    <button onclick="runAllTests()">Run All Tests</button>

    <script src="src/web/static/persistence.js"></script>
    <script>
        const results = document.getElementById('results');

        function addResult(test, passed, message) {
            const div = document.createElement('div');
            div.className = `test-result ${passed ? 'pass' : 'fail'}`;
            div.innerHTML = `<strong>${test}:</strong> ${passed ? 'PASS' : 'FAIL'} - ${message}`;
            results.appendChild(div);
        }

        function testSave() {
            try {
                const testData = {
                    version: MAGIPersistence.VERSION,
                    timestamp: new Date().toISOString(),
                    filing_status: 'Single',
                    tax_year: '2025',
                    wages: '50000',
                    use_standard_deduction: 'true'
                };

                localStorage.setItem(MAGIPersistence.STORAGE_KEY, JSON.stringify(testData));

                const saved = localStorage.getItem(MAGIPersistence.STORAGE_KEY);
                const parsed = JSON.parse(saved);

                if (parsed.filing_status === 'Single' && parsed.wages === '50000') {
                    addResult('Save Test', true, 'Data saved successfully');
                    return true;
                } else {
                    addResult('Save Test', false, 'Saved data does not match');
                    return false;
                }
            } catch (e) {
                addResult('Save Test', false, e.message);
                return false;
            }
        }

        function testLoad() {
            try {
                const data = MAGIPersistence.loadData();

                if (data && data.filing_status === 'Single') {
                    addResult('Load Test', true, `Loaded data: ${JSON.stringify(data, null, 2).substring(0, 100)}...`);
                    return true;
                } else {
                    addResult('Load Test', false, 'Failed to load data or data is incorrect');
                    return false;
                }
            } catch (e) {
                addResult('Load Test', false, e.message);
                return false;
            }
        }

        function testClear() {
            try {
                MAGIPersistence.clearData();
                const data = localStorage.getItem(MAGIPersistence.STORAGE_KEY);

                if (data === null) {
                    addResult('Clear Test', true, 'Data cleared successfully');
                    return true;
                } else {
                    addResult('Clear Test', false, 'Data still exists after clear');
                    return false;
                }
            } catch (e) {
                addResult('Clear Test', false, e.message);
                return false;
            }
        }

        function testTimestamp() {
            try {
                const testData = {
                    version: MAGIPersistence.VERSION,
                    timestamp: new Date(Date.now() - 3600000).toISOString(), // 1 hour ago
                    filing_status: 'Single'
                };

                localStorage.setItem(MAGIPersistence.STORAGE_KEY, JSON.stringify(testData));

                const formatted = MAGIPersistence.formatTimestamp(testData.timestamp);

                if (formatted.includes('hour')) {
                    addResult('Timestamp Test', true, `Formatted: "${formatted}"`);
                    return true;
                } else {
                    addResult('Timestamp Test', false, `Unexpected format: "${formatted}"`);
                    return false;
                }
            } catch (e) {
                addResult('Timestamp Test', false, e.message);
                return false;
            }
        }

        function testLocalStorageAvailability() {
            const available = MAGIPersistence.isLocalStorageAvailable();
            addResult('localStorage Availability', available, available ? 'localStorage is available' : 'localStorage is NOT available');
            return available;
        }

        function runAllTests() {
            results.innerHTML = '';

            testLocalStorageAvailability();
            testSave();
            testLoad();
            testTimestamp();
            testClear();

            console.log('All tests completed');
        }

        // Auto-run tests on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                addResult('Auto-test', true, 'Persistence module loaded successfully');
            }, 100);
        });
    </script>
</body>
</html>
